<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="icon" type="image/png" href="logo2.png" />
    <title>OSINT // RECON - Master Module</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&amp;family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec63",
                        "primary-dim": "#0eac48",
                        "background-light": "#f6f8f7",
                        "background-dark": "#050a07",
                        "surface-dark": "#0f1612",
                        "surface-border": "#1f2e25",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"],
                    },
                    backgroundImage: {
                        'cyber-grid': "linear-gradient(to right, #1f2e25 1px, transparent 1px), linear-gradient(to bottom, #1f2e25 1px, transparent 1px)",
                    }
                },
            },
        }
    </script>
    <style>
        .neon-glow {
            box-shadow: 0 0 10px rgba(19, 236, 99, 0.2);
        }

        .grid-bg {
            background-size: 40px 40px;
            mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f1612;
        }

        ::-webkit-scrollbar-thumb {
            background: #1f2e25;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #13ec63;
        }

        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .nav-active {
            background-color: rgba(19, 236, 99, 0.1);
            border-color: rgba(19, 236, 99, 0.3);
            color: #13ec63;
        }

        .nav-inactive {
            color: #64748b;
            border-color: transparent;
        }

        .nav-inactive:hover {
            color: #f1f5f9;
        }

        #graph-tooltip {
            pointer-events: none;
            transition: opacity 0.2s;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 min-h-screen flex flex-col overflow-x-hidden selection:bg-primary selection:text-black">
    <div class="fixed inset-0 pointer-events-none opacity-20 bg-cyber-grid grid-bg z-0"></div>

    <div class="relative z-10 flex flex-col h-full grow">
        <header
            class="sticky top-0 z-50 flex items-center justify-between border-b border-surface-border bg-surface-dark/95 backdrop-blur-md px-6 py-3">
            <div class="flex items-center gap-4 text-white">
                <div
                    class="size-8 text-primary flex items-center justify-center rounded bg-primary/10 border border-primary/20 neon-glow">
                    <img src="logo2.png" alt="Logo" class="w-6 h-6 object-contain" />
                </div>
                <h2 class="text-white text-xl font-bold tracking-tight uppercase">OSINT <span
                        class="text-primary">//</span> RECON</h2>
            </div>

            <div class="flex md:hidden flex-1 justify-end px-4">
                <button id="mobile-mode-toggle" onclick="toggleMobileNav()" class="text-white p-2">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </div>

            <div class="hidden md:flex flex-1 justify-center px-8">
                <nav class="flex items-center gap-2 p-1 bg-black/40 rounded-lg border border-surface-border">
                    <button onclick="switchMode('PASSIVE')" id="nav-passive"
                        class="nav-active px-4 py-1.5 text-sm font-bold rounded border transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">visibility_off</span> PASSIVE RECON
                    </button>
                    <button onclick="switchMode('ACTIVE')" id="nav-active"
                        class="nav-inactive px-4 py-1.5 text-sm font-bold rounded border transition-colors flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">satellite_alt</span> ACTIVE RECON
                    </button>
                </nav>
            </div>

            <div class="flex items-center gap-4">
                <div id="mode-badge"
                    class="px-3 py-1 border border-surface-border bg-surface-dark rounded text-slate-400 text-xs font-mono flex items-center gap-2">
                    <span class="size-2 bg-slate-500 rounded-full"></span> PASSIVE MODE
                </div>
            </div>
        </header>

        <main class="flex-1 px-4 md:px-8 py-6 w-full max-w-[1600px] mx-auto flex flex-col gap-6">
            <div class="flex flex-col md:flex-row gap-6 items-end justify-between">
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-2 text-primary text-xs font-mono uppercase tracking-widest">
                        <span class="material-symbols-outlined text-[16px] animate-spin-slow">sync</span>System Ready
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black tracking-tight text-white uppercase">Target Acquisition
                    </h1>
                    <p class="text-slate-400 max-w-lg" id="hero-desc">Passive enumeration using Certificate Transparency
                        logs. Zero footprint on target.</p>
                </div>
                <div class="w-full md:w-auto md:min-w-[500px]">
                    <div class="relative group">
                        <div
                            class="absolute -inset-0.5 bg-gradient-to-r from-primary/50 to-emerald-600/50 rounded-lg blur opacity-30 group-hover:opacity-75 transition duration-500">
                        </div>
                        <div
                            class="relative flex items-stretch bg-surface-dark rounded-lg border border-surface-border">
                            <div class="pl-4 flex items-center justify-center text-slate-500">
                                <span class="material-symbols-outlined">globe</span>
                            </div>
                            <input
                                class="w-full bg-transparent border-none text-white font-mono placeholder-slate-600 focus:ring-0 py-4 px-3"
                                placeholder="ENTER TARGET DOMAIN (e.g. google.com)" type="text" id="target-input" />
                            <button
                                class="m-1 px-6 bg-primary hover:bg-primary-dim text-black font-bold uppercase tracking-wide text-sm rounded transition-colors flex items-center gap-2"
                                onclick="startScan()">
                                <span class="material-symbols-outlined text-[18px]">search</span>Scan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-[600px]">
                <div class="flex flex-col gap-6 lg:col-span-1">
                    <div class="grid grid-cols-2 gap-4" id="stats-container">
                        <div
                            class="bg-surface-dark border border-surface-border p-4 rounded-lg flex flex-col justify-between h-[140px] relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-6xl text-primary">dns</span>
                            </div>
                            <div>
                                <span class="text-xs font-mono text-slate-400 uppercase block mb-1">Subdomains</span>
                                <span class="text-3xl font-mono font-bold text-white" id="stat-main">0</span>
                            </div>
                            <div class="flex items-center gap-1 text-xs text-primary">
                                <span class="material-symbols-outlined text-[12px]">trending_up</span>
                                <span id="stat-sub">Waiting...</span>
                            </div>
                        </div>

                        <div
                            class="bg-surface-dark border border-surface-border p-4 rounded-lg flex flex-col justify-between h-[140px] relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-6xl text-amber-500"
                                    id="stat-2-icon">lock_open</span>
                            </div>

                            <div class="relative z-10 flex flex-col justify-between h-full">
                                <div id="stat-content-passive" class="flex flex-col h-full justify-between">
                                    <div>
                                        <span class="text-xs font-mono text-slate-400 uppercase block mb-1">Potential
                                            Risks</span>
                                        <span class="text-3xl font-mono font-bold text-white" id="stat-risk">0</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-xs text-amber-400">
                                        <span class="material-symbols-outlined text-[12px]">warning</span>
                                        <span>Exposure Check</span>
                                    </div>
                                </div>

                                <div id="stat-content-active" class="hidden flex flex-col h-full justify-between">
                                    <div>
                                        <span class="text-xs font-mono text-slate-400 uppercase block mb-1">Resolved
                                            IPs</span>
                                        <span class="text-3xl font-mono font-bold text-white" id="stat-ip">0</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-xs text-blue-400">
                                        <span class="material-symbols-outlined text-[12px]">check_circle</span>
                                        <span>DNS Live</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex-1 bg-surface-dark border border-surface-border rounded-lg p-4 flex flex-col font-mono text-xs overflow-hidden h-64 lg:h-auto">
                        <div class="flex items-center justify-between border-b border-surface-border pb-2 mb-2">
                            <span class="text-slate-300 font-bold uppercase flex items-center gap-2">
                                <span class="material-symbols-outlined text-[14px] text-primary">terminal</span>Event
                                Log
                            </span>
                            <span
                                class="flex size-2 bg-primary rounded-full animate-pulse shadow-[0_0_8px_rgba(19,236,99,0.8)]"></span>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-1 pr-2 text-slate-400 font-mono" id="event-log">
                            <div class="flex gap-2">
                                <span class="text-slate-600">[SYSTEM]</span>
                                <span>AllOSINT Module Loaded. Select mode above.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div
                        class="relative bg-surface-dark border border-surface-border rounded-lg overflow-hidden h-[350px] group bg-cyber-grid">
                        <div class="absolute top-4 left-4 z-20 flex flex-col gap-2">
                            <div
                                class="text-xs text-primary font-mono bg-black/50 p-1 rounded border border-primary/20">
                                LIVE TOPOLOGY // SVG</div>
                        </div>
                        <div class="absolute inset-0 flex items-center justify-center overflow-hidden cursor-crosshair"
                            id="network-graph">
                            <div class="text-slate-500 text-center opacity-50">
                                <span class="material-symbols-outlined text-6xl mb-4 block">hub</span>
                                <p class="font-mono text-sm">Network map will generate upon scan completion</p>
                            </div>
                        </div>

                        <div id="graph-tooltip"
                            class="absolute top-0 left-0 bg-black/95 backdrop-blur border border-surface-border p-3 rounded text-xs font-mono opacity-0 z-30 shadow-xl min-w-[180px]">
                            <span class="block text-white font-bold text-sm mb-1 border-b border-surface-border pb-1"
                                id="tooltip-domain">domain.com</span>
                            <div class="space-y-1 mt-1">
                                <div class="flex justify-between"><span class="text-slate-500">Risk:</span> <span
                                        class="text-slate-300 font-bold" id="tooltip-risk">LOW</span></div>
                                <div class="flex justify-between hidden" id="tooltip-row-ip"><span
                                        class="text-slate-500">IP:</span> <span class="font-bold text-blue-400"
                                        id="tooltip-ip">Pending...</span></div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex flex-col bg-surface-dark border border-surface-border rounded-lg overflow-hidden flex-1 min-h-[500px]">
                        <div
                            class="flex items-center justify-between px-4 py-3 border-b border-surface-border bg-surface-dark">
                            <div class="flex items-center gap-4">
                                <h3 class="font-display font-semibold text-white tracking-wide">RESULTS</h3>
                                <div id="active-controls" class="hidden flex gap-2 animate-in fade-in duration-300">
                                    <button onclick="analyzeAll('ip')"
                                        class="text-[10px] font-mono bg-blue-500/10 text-blue-400 border border-blue-500/30 px-3 py-1 rounded hover:bg-blue-500/20 transition-colors flex items-center gap-1">
                                        <span class="material-symbols-outlined text-[12px]">dns</span> RESOLVE ALL IPs
                                    </button>
                                    <button onclick="analyzeAll('web')"
                                        class="text-[10px] font-mono bg-amber-500/10 text-amber-400 border border-amber-500/30 px-3 py-1 rounded hover:bg-amber-500/20 transition-colors flex items-center gap-1">
                                        <span class="material-symbols-outlined text-[12px]">language</span> CHECK ALL
                                        WEB
                                    </button>
                                </div>
                            </div>
                            <button
                                class="text-xs font-mono text-primary bg-primary/10 border border-primary/20 px-3 py-1 rounded hover:bg-primary/20 transition-colors"
                                onclick="exportResults()">EXPORT CSV</button>
                        </div>

                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-left font-mono text-sm relative">
                                <thead
                                    class="bg-[#0a0f0c] text-slate-400 text-xs uppercase tracking-wider sticky top-0 z-10 shadow-lg">
                                    <tr id="table-headers"></tr>
                                </thead>
                                <tbody class="divide-y divide-surface-border text-slate-300" id="results-table">
                                    <tr>
                                        <td colspan="4" class="px-4 py-8 text-center text-slate-500">
                                            <span class="material-symbols-outlined text-4xl mb-2 block">search</span>
                                            Awaiting Input...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div
                            class="px-4 py-3 border-t border-surface-border flex items-center justify-between text-xs font-mono text-slate-500 bg-[#0a0f0c]">
                            <span id="results-count">Showing 0 results</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- GLOBAL STATE ---
        const STATE = {
            mode: 'PASSIVE',
            scanResults: [],
            isScanning: false,
            dnsIndex: 0
        };
        const DNS_PROVIDERS = ['https://cloudflare-dns.com/dns-query', 'https://dns.google/resolve'];

        document.addEventListener('DOMContentLoaded', () => { updateUI(); });

        // --- GRAPH ENGINE ---
        function drawGraph() {
            const container = document.getElementById('network-graph');

            // Safety check: If no data, show placeholder
            if (!STATE.scanResults || STATE.scanResults.length === 0) {
                container.innerHTML = `<svg width="100%" height="100%"><circle cx="50%" cy="50%" r="5" fill="#fff" class="animate-pulse"></circle></svg>`;
                return;
            }

            const width = container.clientWidth;
            const height = container.clientHeight;

            // Config
            const centerX = width / 2;
            const centerY = height / 2;
            const orbitRadius = Math.min(width, height) * 0.35; // 35% of container
            const nodesToDraw = STATE.scanResults.slice(0, 40); // Cap at 40 nodes to prevent lag

            let svgContent = '';

            // 1. Draw Links (Lines)
            nodesToDraw.forEach((node, i) => {
                const angle = (i / nodesToDraw.length) * Math.PI * 2;
                const radius = orbitRadius + (Math.random() * 40 - 20);
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;

                // Store coordinates for the circle
                node.gx = x;
                node.gy = y;

                // Color based on risk
                let strokeColor = '#13ec63';
                if (node.risk.level === 'MEDIUM') strokeColor = '#fbbf24';
                if (node.risk.level === 'HIGH') strokeColor = '#ef4444';

                svgContent += `<line x1="${centerX}" y1="${centerY}" x2="${x}" y2="${y}" stroke="${strokeColor}" stroke-width="0.5" opacity="0.3" />`;
            });

            // 2. Draw Center Node
            svgContent += `<circle cx="${centerX}" cy="${centerY}" r="6" fill="#fff" stroke="#13ec63" stroke-width="2" class="animate-pulse" />`;

            // 3. Draw Leaf Nodes (Interactive Circles)
            nodesToDraw.forEach((node) => {
                let fillColor = '#13ec63';
                if (node.risk.level === 'MEDIUM') fillColor = '#fbbf24';
                if (node.risk.level === 'HIGH') fillColor = '#ef4444';

                // Sanitize string to prevent breaking the onclick
                const safeSub = node.subdomain.replace(/['"\\]/g, "");

                svgContent += `
                    <circle 
                        cx="${node.gx}" cy="${node.gy}" r="4" 
                        fill="${fillColor}" 
                        stroke="#000" stroke-width="1"
                        style="cursor: pointer; pointer-events: all;"
                        onmouseenter="showGraphTooltip(evt, '${safeSub}', '${node.risk.level}', '${fillColor}')"
                        onmouseleave="hideGraphTooltip()"
                    >
                        <animate attributeName="r" values="4;6;4" dur="${2 + Math.random()}s" repeatCount="indefinite" />
                    </circle>
                `;
            });

            container.innerHTML = `<svg width="100%" height="100%">${svgContent}</svg>`;
        }

        // --- TOOLTIP LOGIC ---
        function showGraphTooltip(evt, sub, risk, color) {
            const tooltip = document.getElementById('graph-tooltip');
            const container = document.getElementById('network-graph').getBoundingClientRect();

            // Get mouse position relative to the container
            const mouseX = evt.clientX - container.left;
            const mouseY = evt.clientY - container.top;

            // Update Tooltip Content
            document.getElementById('tooltip-domain').innerText = sub;
            const riskLabel = document.getElementById('tooltip-risk');
            riskLabel.innerText = risk;
            riskLabel.style.color = color;

            // Check if we have an IP to show (Active Mode)
            const item = STATE.scanResults.find(r => r.subdomain === sub);
            const ipRow = document.getElementById('tooltip-row-ip');
            const ipLabel = document.getElementById('tooltip-ip');

            if (item && item.ip) {
                ipRow.classList.remove('hidden');
                ipLabel.innerText = item.ip;
            } else {
                ipRow.classList.add('hidden');
            }

            // Position and Show
            tooltip.style.left = `${mouseX + 15}px`;
            tooltip.style.top = `${mouseY + 15}px`;
            tooltip.style.opacity = '1';
        }

        function hideGraphTooltip() {
            document.getElementById('graph-tooltip').style.opacity = '0';
        }

        // --- UI LOGIC ---

        function toggleMobileNav() {
            const navPassive = document.getElementById('nav-passive');
            const navActive = document.getElementById('nav-active');
            const currentMode = STATE.mode;

            // Simple toggle between modes on mobile
            if (currentMode === 'PASSIVE') {
                switchMode('ACTIVE');
            } else {
                switchMode('PASSIVE');
            }
        }

        function switchMode(newMode) {
            if (STATE.isScanning) { alert("Please wait for the current scan to finish."); return; }
            STATE.mode = newMode;
            updateUI();
            renderTable();
            updateStats();
        }

        function updateUI() {
            const navPassive = document.getElementById('nav-passive');
            const navActive = document.getElementById('nav-active');
            const badge = document.getElementById('mode-badge');
            const activeControls = document.getElementById('active-controls');
            const statPassive = document.getElementById('stat-content-passive');
            const statActive = document.getElementById('stat-content-active');
            const statIcon = document.getElementById('stat-2-icon');

            if (STATE.mode === 'PASSIVE') {
                navPassive.className = "nav-active px-4 py-1.5 text-sm font-bold rounded border transition-colors flex items-center gap-2";
                navActive.className = "nav-inactive px-4 py-1.5 text-sm font-bold rounded border transition-colors flex items-center gap-2";
                badge.innerHTML = `<span class="size-2 bg-slate-500 rounded-full"></span> PASSIVE MODE`;
                badge.className = "px-3 py-1 border border-surface-border bg-surface-dark rounded text-slate-400 text-xs font-mono flex items-center gap-2";

                activeControls.classList.add('hidden');
                statActive.classList.add('hidden');
                statPassive.classList.remove('hidden');
                statIcon.className = "material-symbols-outlined text-6xl text-amber-500";
                document.getElementById('hero-desc').innerText = "Passive enumeration using Certificate Transparency logs. Zero footprint on target.";
            } else {
                navPassive.className = "nav-inactive px-4 py-1.5 text-sm font-bold rounded border transition-colors flex items-center gap-2";
                navActive.className = "nav-active px-4 py-1.5 text-sm font-bold rounded border transition-colors flex items-center gap-2";
                badge.innerHTML = `<span class="size-2 bg-red-500 rounded-full animate-pulse"></span> ACTIVE MODE`;
                badge.className = "px-3 py-1 border border-red-900 bg-red-900/10 rounded text-red-400 text-xs font-mono flex items-center gap-2";

                activeControls.classList.remove('hidden');
                statPassive.classList.add('hidden');
                statActive.classList.remove('hidden');
                statIcon.className = "material-symbols-outlined text-6xl text-blue-500";
                document.getElementById('hero-desc').innerText = "Active Recon enabled. Performing DNS Resolution & Port Liveness checks.";
            }
        }

        function startScan() {
            const target = document.getElementById('target-input').value.trim();
            if (!target) { alert('Please enter a target domain'); return; }
            if (STATE.isScanning) return;

            STATE.isScanning = true;
            STATE.scanResults = [];
            document.getElementById('results-table').innerHTML = `<tr><td colspan="4" class="px-4 py-12 text-center text-slate-500"><span class="material-symbols-outlined text-4xl mb-4 block animate-spin text-primary">radar</span><span class="animate-pulse">Querying Certificate Transparency Logs...</span></td></tr>`;
            addToLog(`Initiating Scan for: ${target}`, 'success');
            setTimeout(() => fetchPassive(target), 800);
        }

        async function fetchPassive(domain) {
            try {
                const response = await fetch(`https://crt.sh/?q=${domain}&output=json`);
                if (!response.ok) throw new Error("crt.sh unreachable");
                const data = await response.json();
                const uniqueSet = new Set();
                const processed = [];

                data.forEach(entry => {
                    const rawNames = entry.name_value.split('\n');
                    rawNames.forEach(name => {
                        if (!name.includes('*') && !uniqueSet.has(name)) {
                            uniqueSet.add(name);
                            processed.push({
                                id: Math.random().toString(36).substr(2, 9),
                                subdomain: name,
                                environment: detectEnv(name),
                                ip: null,
                                webStatus: 'Pending',
                                risk: analyzeRisk(name)
                            });
                        }
                    });
                });

                STATE.scanResults = processed;
                addToLog(`Scan Complete. Found ${STATE.scanResults.length} assets.`, 'success');
                renderTable();
                updateStats();
                drawGraph();
                STATE.isScanning = false;
                
                // Save to database
                await saveToDatabase(domain, processed);
            } catch (error) {
                addToLog(`Scan Failed: ${error.message}`, 'error');
                STATE.isScanning = false;
                renderTable();
            }
        }

        async function saveToDatabase(domain, subdomains) {
            try {
                const { createClient } = supabase;
                const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data: userProfile } = await supabaseClient.from('users').select('credits').eq('id', user.id).single();
                if (!userProfile || userProfile.credits < 1) return;

                const summary = {
                    domain: domain,
                    subdomain_count: subdomains.length,
                    environments: [...new Set(subdomains.map(s => s.environment))],
                    high_risk_count: subdomains.filter(s => s.risk.level === 'HIGH').length,
                    status: 'completed'
                };

                const { data: searchData, error } = await supabaseClient.from('search_history').insert({
                    user_id: user.id,
                    module_type: 'subdomain_recon',
                    query_input: domain,
                    result_summary: summary,
                    full_result: subdomains,
                    status: 'completed',
                    credits_used: 1
                }).select().single();

                if (!error) {
                    await supabaseClient.rpc('deduct_credits', {
                        p_user_id: user.id,
                        p_amount: 1,
                        p_module_type: 'subdomain_recon',
                        p_search_id: searchData.id
                    });
                    console.log('âœ“ Subdomain scan saved (-1 credit)');
                }
            } catch (err) {
                console.error('Error saving:', err);
            }
        }

        function renderTable() {
            const thead = document.getElementById('table-headers');
            const tbody = document.getElementById('results-table');

            if (STATE.scanResults.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-500">No data available.</td></tr>`;
                return;
            }

            if (STATE.mode === 'PASSIVE') {
                thead.innerHTML = `
            <th class="px-4 py-3 font-medium border-b border-surface-border w-[40%]">Subdomain</th>
            <th class="px-4 py-3 font-medium border-b border-surface-border">Environment</th>
            <th class="px-4 py-3 font-medium border-b border-surface-border">Risk Assessment</th>
            <th class="px-4 py-3 font-medium border-b border-surface-border text-right">Source</th>
        `;
                tbody.innerHTML = STATE.scanResults.map(r => `
            <tr class="hover:bg-primary/5 transition-colors border-b border-surface-border/50">
                <td class="px-4 py-3 font-mono text-white">${r.subdomain}</td>
                <td class="px-4 py-3 font-mono text-slate-500 text-xs uppercase">${r.environment}</td>
                <td class="px-4 py-3">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold border ${r.risk.class}">${r.risk.level}</span>
                </td>
                <td class="px-4 py-3 text-right text-slate-500 text-xs">crt.sh</td>
            </tr>
        `).join('');
            } else {
                thead.innerHTML = `
            <th class="px-4 py-3 font-medium border-b border-surface-border w-[35%]">Subdomain</th>
            <th class="px-4 py-3 font-medium border-b border-surface-border">Resolved IP</th>
            <th class="px-4 py-3 font-medium border-b border-surface-border text-center">Port 80/443</th>
            <th class="px-4 py-3 font-medium border-b border-surface-border text-right">Active Action</th>
        `;
                tbody.innerHTML = STATE.scanResults.map(r => `
            <tr id="row-${r.id}" class="hover:bg-primary/5 transition-colors border-b border-surface-border/50">
                <td class="px-4 py-3 font-mono text-white">${r.subdomain}</td>
                <td class="px-4 py-3 font-mono text-slate-400 col-ip text-sm">${r.ip || '<span class="opacity-30">Unresolved</span>'}</td>
                <td class="px-4 py-3 font-mono text-center col-web text-sm">${renderWebStatus(r.webStatus)}</td>
                <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-2">
                         <button onclick="resolveSingleIP('${r.id}')" class="p-1 hover:text-blue-400 text-slate-500 transition-colors"><span class="material-symbols-outlined text-[18px]">dns</span></button>
                         <button onclick="checkSingleWeb('${r.id}')" class="p-1 hover:text-amber-400 text-slate-500 transition-colors"><span class="material-symbols-outlined text-[18px]">language</span></button>
                    </div>
                </td>
            </tr>
        `).join('');
            }
            document.getElementById('results-count').innerText = `Showing ${STATE.scanResults.length} results`;
        }

        function renderWebStatus(status) {
            if (status === 'Pending') return '<span class="opacity-30">-</span>';
            if (status === 'Checking...') return '<span class="animate-pulse text-amber-500">...</span>';
            if (status.includes('UP') || status.includes('HTTP')) return `<span class="text-primary font-bold">UP (Live)</span>`;
            return `<span class="text-red-500">Closed</span>`;
        }

        async function resolveSingleIP(id) {
            const item = STATE.scanResults.find(r => r.id === id);
            if (!item) return;
            const row = document.getElementById(`row-${id}`);
            if (row) row.querySelector('.col-ip').innerHTML = '<span class="animate-pulse text-blue-400">Querying...</span>';
            const provider = DNS_PROVIDERS[STATE.dnsIndex % DNS_PROVIDERS.length];
            STATE.dnsIndex++;

            try {
                const url = `${provider}?name=${item.subdomain}&type=A`;
                const res = await fetch(url, { headers: { 'Accept': 'application/dns-json' } });
                const data = await res.json();
                if (data.Answer && data.Answer.length > 0) {
                    item.ip = data.Answer[data.Answer.length - 1].data;
                    addToLog(`Resolved ${item.subdomain} -> ${item.ip}`, 'info');
                } else {
                    item.ip = "NXDOMAIN";
                }
            } catch (e) { item.ip = "Error"; }

            if (row) row.querySelector('.col-ip').innerText = item.ip;
            updateStats();
        }

        async function checkSingleWeb(id) {
            const item = STATE.scanResults.find(r => r.id === id);
            if (!item) return;
            const row = document.getElementById(`row-${id}`);
            if (row) row.querySelector('.col-web').innerHTML = renderWebStatus('Checking...');

            const check = async (proto) => {
                const controller = new AbortController();
                const tid = setTimeout(() => controller.abort(), 2000);
                try {
                    await fetch(`${proto}://${item.subdomain}`, { method: 'HEAD', mode: 'no-cors', signal: controller.signal });
                    clearTimeout(tid);
                    return true;
                } catch (e) {
                    clearTimeout(tid);
                    if (e.name === 'AbortError') return false;
                    return true;
                }
            };

            const [http, https] = await Promise.all([check('http'), check('https')]);
            let status = "";
            if (http || https) status = "HTTP/HTTPS UP";
            else status = "Closed";

            item.webStatus = status;
            if (row) row.querySelector('.col-web').innerHTML = renderWebStatus(status);
        }

        async function analyzeAll(type) {
            addToLog(`Starting Batch ${type.toUpperCase()} Analysis...`, 'action');
            const CHUNK_SIZE = 5;
            for (let i = 0; i < STATE.scanResults.length; i += CHUNK_SIZE) {
                const chunk = STATE.scanResults.slice(i, i + CHUNK_SIZE);
                const promises = chunk.map(item => {
                    if (type === 'ip' && !item.ip) return resolveSingleIP(item.id);
                    if (type === 'web' && item.webStatus === 'Pending') return checkSingleWeb(item.id);
                    return Promise.resolve();
                });
                await Promise.all(promises);
                await new Promise(r => setTimeout(r, 200));
            }
            addToLog("Batch Analysis Complete.", 'success');
        }

        function updateStats() {
            document.getElementById('stat-main').innerText = STATE.scanResults.length;
            // FIXED: Now counts both HIGH and MEDIUM risks
            const risks = STATE.scanResults.filter(r => r.risk.level === 'HIGH' || r.risk.level === 'MEDIUM').length;
            document.getElementById('stat-risk').innerText = risks;
            const resolved = STATE.scanResults.filter(r => r.ip && r.ip !== 'NXDOMAIN' && r.ip !== 'Error').length;
            document.getElementById('stat-ip').innerText = resolved;
        }

        function detectEnv(name) {
            if (name.includes('dev')) return 'Development';
            if (name.includes('stg') || name.includes('stage')) return 'Staging';
            if (name.includes('admin')) return 'Admin Panel';
            return 'Production';
        }

        function analyzeRisk(name) {
            const highRisk = ['admin', 'vpn', 'portal', 'internal', 'git', 'conf'];
            const medRisk = ['dev', 'test', 'beta', 'api', 'stg'];
            if (highRisk.some(k => name.includes(k))) return { level: 'HIGH', class: 'text-red-400 bg-red-500/10 border-red-500/30' };
            if (medRisk.some(k => name.includes(k))) return { level: 'MEDIUM', class: 'text-amber-400 bg-amber-500/10 border-amber-500/30' };
            return { level: 'LOW', class: 'text-slate-400 bg-slate-700/10 border-slate-600/30' };
        }

        function addToLog(msg, type) {
            const log = document.getElementById('event-log');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            let color = 'text-slate-400';
            if (type === 'success') color = 'text-primary';
            if (type === 'error') color = 'text-red-400';
            if (type === 'action') color = 'text-blue-400';
            const div = document.createElement('div');
            div.innerHTML = `<span class="text-slate-600">[${time}]</span> <span class="${color}">${msg}</span>`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function exportResults() {
            if (STATE.scanResults.length === 0) { alert('No data to export.'); return; }
            let csvContent = "data:text/csv;charset=utf-8,";
            if (STATE.mode === 'PASSIVE') {
                csvContent += "Subdomain,Environment,Risk Level\n";
                STATE.scanResults.forEach(r => csvContent += `${r.subdomain},${r.environment},${r.risk.level}\n`);
            } else {
                csvContent += "Subdomain,IP Address,Web Status\n";
                STATE.scanResults.forEach(r => csvContent += `${r.subdomain},${r.ip || 'N/A'},${r.webStatus}\n`);
            }
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `allosint_${STATE.mode.toLowerCase()}_scan.csv`);
            document.body.appendChild(link);
            link.click();
        }

        document.getElementById('target-input').addEventListener('keypress', function (e) { if (e.key === 'Enter') startScan(); });
    </script>
</body>

</html>