<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="icon" type="image/png" href="logo2.png" />
    <title>OSINT // PORT SCANNER</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec63",
                        "primary-dim": "#0eac48",
                        "danger": "#ef4444",
                        "warning": "#eab308",
                        "background-light": "#f6f8f7",
                        "background-dark": "#050a07",
                        "surface-dark": "#0f1612",
                        "surface-border": "#1f2e25",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"],
                    },
                    backgroundImage: {
                        'cyber-grid': "linear-gradient(to right, #1f2e25 1px, transparent 1px), linear-gradient(to bottom, #1f2e25 1px, transparent 1px)",
                    }
                },
            },
        }
    </script>
    <style>
        .neon-glow {
            box-shadow: 0 0 10px rgba(19, 236, 99, 0.2);
        }

        .grid-bg {
            background-size: 40px 40px;
            mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f1612;
        }

        ::-webkit-scrollbar-thumb {
            background: #1f2e25;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #13ec63;
        }

        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }

        .terminal-text {
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.4;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 min-h-screen flex flex-col overflow-x-hidden selection:bg-primary selection:text-black">
    <div class="fixed inset-0 pointer-events-none opacity-20 bg-cyber-grid grid-bg z-0"></div>

    <div class="relative z-10 flex flex-col h-full grow">
        <header
            class="sticky top-0 z-50 flex items-center justify-between border-b border-surface-border bg-surface-dark/95 backdrop-blur-md px-6 py-3">
            <div class="flex items-center gap-4 text-white">
                <div
                    class="size-8 text-primary flex items-center justify-center rounded bg-primary/10 border border-primary/20 neon-glow">
                    <img src="logo2.png" alt="Logo" class="w-6 h-6 object-contain" />
                </div>
                <h2 class="text-white text-xl font-bold tracking-tight uppercase">OSINT <span
                        class="text-primary">//</span> PORT SCANNER</h2>
            </div>

            <div class="hidden md:flex flex-1 justify-center px-8">
                <nav class="flex items-center gap-2 p-1 bg-black/40 rounded-lg border border-surface-border">
                    <a href="dashboard.html"
                        class="px-4 py-1.5 text-sm font-medium text-slate-400 hover:text-white hover:bg-surface-border/50 rounded transition-colors">Dashboard</a>
                    <a href="#"
                        class="px-4 py-1.5 text-sm font-bold text-primary bg-primary/10 border border-primary/20 rounded shadow shadow-primary/10">Scanner</a>
                </nav>
            </div>

            <div class="flex items-center gap-4">
                <div class="size-9 rounded-full bg-gradient-to-br from-primary to-blue-500 p-[1px]">
                    <div
                        class="size-full rounded-full bg-surface-dark flex items-center justify-center overflow-hidden">
                        <span class="material-symbols-outlined text-white text-[20px]">person</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 px-4 md:px-8 py-6 w-full max-w-[1600px] mx-auto flex flex-col gap-6">
            <div class="flex flex-col md:flex-row gap-6 items-end justify-between">
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-2 text-primary text-xs font-mono uppercase tracking-widest">
                        <span class="material-symbols-outlined text-[16px] animate-spin-slow">sync</span>System Ready
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black tracking-tight text-white uppercase">Port Intelligence
                    </h1>
                    <p class="text-slate-400 max-w-lg">Leverages InternetDB & passive routing analysis to identify open
                        ports, service banners, and CVEs.</p>
                </div>
                <div class="w-full md:w-auto md:min-w-[500px]">
                    <div class="relative group">
                        <div
                            class="absolute -inset-0.5 bg-gradient-to-r from-primary/50 to-emerald-600/50 rounded-lg blur opacity-30 group-hover:opacity-75 transition duration-500">
                        </div>
                        <div
                            class="relative flex items-stretch bg-surface-dark rounded-lg border border-surface-border">
                            <div class="pl-4 flex items-center justify-center text-slate-500">
                                <span class="material-symbols-outlined">wifi_tethering</span>
                            </div>
                            <input
                                class="w-full bg-transparent border-none text-white font-mono placeholder-slate-600 focus:ring-0 py-4 px-3"
                                placeholder="ENTER IP OR DOMAIN (e.g. scanme.nmap.org)" type="text" id="target-input" />
                            <button
                                class="m-1 px-6 bg-primary hover:bg-primary-dim text-black font-bold uppercase tracking-wide text-sm rounded transition-colors flex items-center gap-2"
                                onclick="startScan()">
                                <span class="material-symbols-outlined text-[18px]">play_circle</span>INITIATE
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-[600px]">
                <div class="flex flex-col gap-6 lg:col-span-1">
                    <div class="grid grid-cols-2 gap-4">
                        <div
                            class="bg-surface-dark border border-surface-border p-4 rounded-lg flex flex-col gap-1 relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-6xl text-primary">lan</span>
                            </div>
                            <span class="text-xs font-mono text-slate-400 uppercase">Open Ports</span>
                            <span class="text-3xl font-mono font-bold text-white" id="stat-open-ports">0</span>
                            <div class="flex items-center gap-1 text-xs text-primary mt-2">
                                <span class="material-symbols-outlined text-[12px]">check_circle</span>
                                <span id="stat-status">Idle</span>
                            </div>
                        </div>
                        <div
                            class="bg-surface-dark border border-surface-border p-4 rounded-lg flex flex-col gap-1 relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-6xl text-danger">bug_report</span>
                            </div>
                            <span class="text-xs font-mono text-slate-400 uppercase">Vulns (CVEs)</span>
                            <span class="text-3xl font-mono font-bold text-white" id="stat-vulns">0</span>
                            <div class="flex items-center gap-1 text-xs text-danger mt-2">
                                <span class="material-symbols-outlined text-[12px]">warning</span>
                                <span id="stat-threat">Low Risk</span>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex-1 bg-surface-dark border border-surface-border rounded-lg flex flex-col overflow-hidden h-96 shadow-2xl">
                        <div
                            class="bg-[#0c0e12] px-4 py-2 flex items-center justify-between border-b border-surface-border">
                            <div class="flex items-center gap-2">
                                <div class="flex gap-1.5">
                                    <div class="size-2.5 rounded-full bg-red-500"></div>
                                    <div class="size-2.5 rounded-full bg-amber-500"></div>
                                    <div class="size-2.5 rounded-full bg-green-500"></div>
                                </div>
                                <span class="ml-2 text-xs font-mono text-slate-400">root@allosint:~#</span>
                            </div>
                        </div>
                        <div class="p-4 font-mono text-xs leading-relaxed overflow-y-auto h-full terminal-text text-slate-300"
                            id="terminal-output">
                            <div class="mb-2">
                                <span class="text-primary">➜</span> <span class="text-slate-400">~</span> <span
                                    class="text-white">System ready. Awaiting target...</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-surface-dark border border-surface-border p-4 rounded-lg">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[16px]">public</span> Target
                            Location
                        </h3>
                        <div id="geo-info" class="space-y-2 text-sm font-mono text-white">
                            <p class="text-slate-500 italic">No Data.</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div
                        class="flex flex-col bg-surface-dark border border-surface-border rounded-lg overflow-hidden flex-1 min-h-[600px]">
                        <div
                            class="flex items-center justify-between px-4 py-3 border-b border-surface-border bg-surface-dark">
                            <h3 class="font-display font-semibold text-white tracking-wide">PORT MATRIX & VULNERABILITY
                                FEED</h3>
                            <div class="flex gap-2">
                                <div class="flex items-center gap-2 text-xs font-mono text-slate-500 mr-4">
                                    <span class="size-2 bg-primary rounded-sm"></span> OPEN
                                    <span class="size-2 bg-surface-border rounded-sm ml-2"></span> CLOSED
                                </div>
                                <button
                                    class="text-xs font-mono text-primary bg-primary/10 border border-primary/20 px-3 py-1 rounded hover:bg-primary/20 transition-colors flex items-center gap-2"
                                    onclick="exportReport()">
                                    <span class="material-symbols-outlined text-[14px]">download</span> CSV EXPORT
                                </button>
                            </div>
                        </div>

                        <div class="p-6 border-b border-surface-border">
                            <div class="grid grid-cols-8 sm:grid-cols-10 md:grid-cols-12 gap-2" id="port-grid">
                                <p class="col-span-full text-center text-slate-500 py-10 font-mono">Initiate scan to
                                    visualize port map.</p>
                            </div>
                        </div>

                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-left font-mono text-sm">
                                <thead class="bg-[#0a0f0c] text-slate-400 text-xs uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-3 border-b border-surface-border">Port / Service</th>
                                        <th class="px-6 py-3 border-b border-surface-border">Tags / CPEs</th>
                                        <th class="px-6 py-3 border-b border-surface-border text-right">Vulnerabilities
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-surface-border text-slate-300" id="vuln-table">
                                    <tr>
                                        <td colspan="3" class="px-6 py-12 text-center text-slate-500">
                                            No open ports detected yet.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // --- CONFIG & STATE ---
        const STATE = {
            target: '',
            ip: null,
            openPorts: [],
            vulns: [],
            tags: [],
            geo: null
        };

        // Known Service Dictionary for Mapping
        const PORT_SERVICES = {
            21: 'FTP', 22: 'SSH', 23: 'TELNET', 25: 'SMTP', 53: 'DNS', 80: 'HTTP',
            110: 'POP3', 135: 'RPC', 139: 'NETBIOS', 143: 'IMAP', 443: 'HTTPS',
            445: 'SMB', 3306: 'MYSQL', 3389: 'RDP', 5432: 'PGSQL', 5900: 'VNC',
            8080: 'HTTP-ALT', 8443: 'HTTPS-ALT'
        };

        const COMMON_PORTS = [21, 22, 23, 25, 53, 80, 110, 135, 139, 143, 443, 445, 993, 995, 1433, 3306, 3389, 5432, 5900, 8080, 8443, 27017];

        // --- CORE FUNCTIONS ---

        async function startScan() {
            const input = document.getElementById('target-input').value.trim();
            if (!input) { alert("Please enter a target."); return; }

            // 1. Terminal Init
            const term = document.getElementById('terminal-output');
            term.innerHTML = ''; // Clear previous

            const banner = document.createElement('div');
            banner.className = "text-primary mb-2 whitespace-pre leading-none font-bold";
            banner.innerText = `
  ___  _  _  ___  ___ _  _ _____ 
 / _ \\| || |/ _ \\/ __| || |_   _|
| (_) | || | (_) \\__ \\ || | | |  
 \\___/|_||_|\\___/|___/_||_| |_|  
    `;
            term.appendChild(banner);

            addToLog("WARNING: Authorized Testing Only. Unauthorized scanning is illegal.", 'error');
            addToLog(`Initializing Passive Scan for: ${input}...`, 'info');

            // Reset UI
            STATE.target = input;
            STATE.openPorts = [];
            STATE.vulns = [];
            document.getElementById('port-grid').innerHTML = '<p class="col-span-full text-center text-primary animate-pulse py-10 font-mono">Scanning Network...</p>';

            try {
                // 2. Resolve DNS
                await resolveDNS(input);

                // 3. Get Geo Info
                fetchGeo(STATE.ip);

                // 4. Get Port Data
                await fetchPortData(STATE.ip);

            } catch (e) {
                addToLog(`CRITICAL FAILURE: ${e.message}`, 'error');
            }
        }

        async function resolveDNS(query) {
            if (/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(query)) {
                STATE.ip = query;
                addToLog(`Target is already an IP: ${STATE.ip}`, 'success');
                return;
            }

            addToLog("Connecting to Cloudflare DoH API...");
            try {
                const res = await fetch(`https://cloudflare-dns.com/dns-query?name=${query}&type=A`, {
                    headers: { 'Accept': 'application/dns-json' }
                });
                const data = await res.json();

                if (data.Answer) {
                    STATE.ip = data.Answer[data.Answer.length - 1].data;
                    addToLog(`DNS Resolved: ${query} -> ${STATE.ip}`, 'success');
                } else {
                    throw new Error("NXDOMAIN (Domain not found)");
                }
            } catch (e) {
                throw new Error("DNS Resolution Failed.");
            }
        }

        async function fetchGeo(ip) {
            addToLog(`Fetching Geo-Intelligence via ipapi.co...`);
            try {
                const res = await fetch(`https://ipapi.co/${ip}/json/`);
                const data = await res.json();
                STATE.geo = data;

                const geoHTML = `
            <div class="flex justify-between border-b border-surface-border pb-1"><span>ISP:</span> <span class="text-white">${data.org || 'N/A'}</span></div>
            <div class="flex justify-between border-b border-surface-border pb-1"><span>Location:</span> <span class="text-white">${data.city}, ${data.country_code}</span></div>
            <div class="flex justify-between"><span>ASN:</span> <span class="text-primary">${data.asn || 'N/A'}</span></div>
        `;
                document.getElementById('geo-info').innerHTML = geoHTML;
                addToLog(`Target located in ${data.country_name} (${data.org})`, 'info');
            } catch (e) {
                addToLog("Geo lookup failed (Rate limit likely).", 'warning');
            }
        }

        async function fetchPortData(ip) {
            addToLog(`Querying InternetDB (Shodan) for open ports...`);

            try {
                const res = await fetch(`https://internetdb.shodan.io/${ip}`);
                if (res.status === 404) {
                    addToLog("No open ports found in public database.", 'warning');
                    renderGrid([]);
                    printSummary();
                    return;
                }

                const data = await res.json();
                STATE.openPorts = data.ports || [];
                STATE.vulns = data.vulns || [];
                STATE.tags = data.tags || [];

                addToLog(`Data Received: Found ${STATE.openPorts.length} Open Ports.`, 'success');
                if (STATE.vulns.length > 0) addToLog(`WARNING: ${STATE.vulns.length} CVEs identified!`, 'error');

                updateStats();
                renderGrid(STATE.openPorts);
                renderTable(data);
                printSummary();

            } catch (e) {
                addToLog("Failed to connect to InternetDB.", 'error');
            }
        }

        function printSummary() {
            const term = document.getElementById('terminal-output');
            const summary = document.createElement('div');
            summary.className = "mt-4 p-2 border-t border-slate-700 text-slate-300";
            summary.innerHTML = `
        <div class="font-bold text-white mb-1">--- SCAN SUMMARY ---</div>
        <div>> Target: <span class="text-primary">${STATE.target}</span> (${STATE.ip})</div>
        <div>> Ports Found: ${STATE.openPorts.length}</div>
        <div>> APIs Used: InternetDB, Cloudflare, ipapi</div>
        <div>> Status: <span class="text-primary">COMPLETED</span></div>
    `;
            term.appendChild(summary);
            term.scrollTop = term.scrollHeight;
            
            // Save to database
            saveToDatabase();
        }

        async function saveToDatabase() {
            try {
                // Step 1: Get authenticated user
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                
                if (authError || !user) {
                    console.log('User not authenticated:', authError);
                    addToLog('⚠ Not logged in - scan not saved', 'warning');
                    return;
                }

                console.log('Authenticated user:', user.id);

                // Step 2: Verify user exists in public.users table
                const { data: userProfile, error: profileError } = await supabaseClient
                    .from('users')
                    .select('id, credits, codename')
                    .eq('id', user.id)
                    .single();

                if (profileError || !userProfile) {
                    console.error('User profile not found:', profileError);
                    addToLog('⚠ User profile not found - please re-login', 'error');
                    return;
                }

                console.log('User profile found:', userProfile);

                // Step 3: Check if user has enough credits
                if (userProfile.credits < 1) {
                    addToLog('⚠ Insufficient credits (need 1)', 'error');
                    alert('Insufficient credits! You need at least 1 credit to perform this scan.');
                    return;
                }

                // Step 4: Create result summary
                const summary = {
                    target: STATE.target,
                    ip: STATE.ip,
                    open_port_count: STATE.openPorts.length,
                    open_ports: STATE.openPorts,
                    vulnerability_count: STATE.vulns.length,
                    vulnerabilities: STATE.vulns,
                    tags: STATE.tags,
                    location: STATE.geo ? `${STATE.geo.country_name} - ${STATE.geo.city}` : 'Unknown',
                    isp: STATE.geo ? STATE.geo.org : 'Unknown',
                    status: 'completed'
                };

                console.log('Saving scan with summary:', summary);

                // Step 5: Insert into search_history
                const { data: searchData, error: searchError } = await supabaseClient
                    .from('search_history')
                    .insert({
                        user_id: user.id,
                        module_type: 'port_scanner',
                        query_input: STATE.target,
                        result_summary: summary,
                        full_result: {
                            ip: STATE.ip,
                            ports: STATE.openPorts,
                            vulns: STATE.vulns,
                            tags: STATE.tags,
                            geo: STATE.geo
                        },
                        status: 'completed',
                        credits_used: 1
                    })
                    .select()
                    .single();

                if (searchError) {
                    console.error('Failed to save search history:', searchError);
                    addToLog('❌ Error saving scan: ' + searchError.message, 'error');
                    return;
                }

                console.log('Scan saved successfully:', searchData);

                // Step 6: Deduct credits
                const { data: creditResult, error: creditError } = await supabaseClient
                    .rpc('deduct_credits', {
                        p_user_id: user.id,
                        p_amount: 1,
                        p_module_type: 'port_scanner',
                        p_search_id: searchData.id
                    });

                if (creditError) {
                    console.error('Credit deduction failed:', creditError);
                    addToLog('⚠ Credits not deducted: ' + creditError.message, 'warning');
                } else {
                    console.log('Credits deducted successfully');
                    addToLog('✓ Scan saved to history (-1 credit)', 'success');
                }

            } catch (err) {
                console.error('Unexpected error in saveToDatabase:', err);
                addToLog('❌ Error: ' + err.message, 'error');
            }
        }

        // --- RENDERING ---

        function updateStats() {
            document.getElementById('stat-open-ports').innerText = STATE.openPorts.length;
            document.getElementById('stat-vulns').innerText = STATE.vulns.length;
            document.getElementById('stat-status').innerText = "Scan Complete";

            const threatLabel = document.getElementById('stat-threat');
            if (STATE.vulns.length > 0) {
                threatLabel.innerText = "CRITICAL RISK";
                threatLabel.className = "text-danger font-bold animate-pulse";
            } else if (STATE.openPorts.length > 5) {
                threatLabel.innerText = "Medium Exposure";
                threatLabel.className = "text-amber-400";
            }
        }

        function renderGrid(openPorts) {
            const grid = document.getElementById('port-grid');
            grid.innerHTML = '';

            const allPortsToShow = [...new Set([...COMMON_PORTS, ...openPorts])].sort((a, b) => a - b);

            allPortsToShow.forEach(port => {
                const isOpen = openPorts.includes(port);
                // Map Port to Service Name (e.g., 80 -> HTTP)
                const serviceName = PORT_SERVICES[port] || 'TCP';

                const div = document.createElement('div');
                div.className = `
            flex flex-col items-center justify-center p-2 rounded border
            transition-all duration-300
            ${isOpen
                        ? 'bg-primary/20 border-primary text-primary shadow-[0_0_10px_rgba(19,236,99,0.3)]'
                        : 'bg-surface-dark border-surface-border text-slate-600 opacity-50'}
        `;
                div.innerHTML = `
            <span class="text-[10px] font-bold">${serviceName}</span>
            <span class="text-sm font-mono">${port}</span>
        `;
                grid.appendChild(div);
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('vuln-table');
            if (data.ports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center">No open ports.</td></tr>';
                return;
            }

            let html = '';

            data.ports.forEach(port => {
                const tags = data.tags ? data.tags.join(', ') : 'None';
                const hasVulns = data.vulns && data.vulns.length > 0;
                const serviceName = PORT_SERVICES[port] || 'TCP';

                html += `
            <tr class="hover:bg-primary/5 border-b border-surface-border/50">
                <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                        <span class="text-primary font-mono font-bold">${port} / ${serviceName}</span>
                        ${hasVulns ? '<span class="px-1.5 py-0.5 bg-danger/20 text-danger text-[10px] rounded border border-danger/30">VULN</span>' : ''}
                    </div>
                </td>
                <td class="px-6 py-4 text-slate-400 text-xs">${tags}</td>
                <td class="px-6 py-4 text-right">
                    ${hasVulns
                        ? `<span class="text-danger font-bold cursor-help" title="${data.vulns.join(', ')}">${data.vulns.length} CVEs Detected</span>`
                        : '<span class="text-slate-600">Clean</span>'}
                </td>
            </tr>
        `;
            });
            tbody.innerHTML = html;
        }

        function addToLog(msg, type = 'info') {
            const term = document.getElementById('terminal-output');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            let color = 'text-slate-300';
            if (type === 'success') color = 'text-primary';
            if (type === 'error') color = 'text-danger';
            if (type === 'warning') color = 'text-warning';

            const line = document.createElement('div');
            line.className = "mb-1";
            line.innerHTML = `<span class="text-slate-500">[${time}]</span> <span class="${color}">${msg}</span>`;
            term.appendChild(line);
            term.scrollTop = term.scrollHeight;
        }

        function exportReport() {
            if (!STATE.ip) { alert("No data."); return; }
            const csvContent = "data:text/csv;charset=utf-8,"
                + "IP,Port,Service,Tags,Vulns\n"
                + STATE.openPorts.map(p => `${STATE.ip},${p},${PORT_SERVICES[p] || 'TCP'},${STATE.tags.join(' ')},${STATE.vulns.length}`).join("\n");
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `port_scan_${STATE.ip}.csv`;
            document.body.appendChild(link);
            link.click();
            addToLog("Report exported to CSV.", 'success');
        }

        // Enter Key Support
        document.getElementById('target-input').addEventListener('keypress', function (e) { if (e.key === 'Enter') startScan(); });

    </script>
</body>

</html>